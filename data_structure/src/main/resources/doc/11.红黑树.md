## 红黑树

> 红黑树也是一种自平衡的二叉搜索树，以前也被称为平衡二叉B树。

红黑树必须满足以下五条性质：

- 节点是red或者black的。
- 根节点是black的。
- 叶子节点(外部节点，空节点都是black的。
- red节点的字节点必须是black。
  - 红色节点的parent都是black。
  - 根节点到叶子节点的所有路径都不能有2个连续的red节点。
- 从任一节点到叶子节点的所有路径都包含相同数目的black节点

![image-20210324214018018](https://gitee.com/code1997/blog-image/raw/master/images/image-20210324214018018.png)

### 1 B树

> B树是一种平衡的多路搜索树，多用于文件系统，数据库的实现。

#### 1.1 B树特点：

- 一个节点可以存储超过2个元素，可以拥有超过2个子节点。
- 拥有二叉搜索树的一些性质。
- 平衡，每个节点的所有子树高度一致。
- 树的高度比较矮。

![image-20210324214610277](https://gitee.com/code1997/blog-image/raw/master/images/image-20210324214610277.png)

#### 1.2 m阶B树的性质(m>=2)

> 数据库中常用200~300阶B树。

假设一个节点存储的元素个数为x。

- 根节点：1<=x<=m-1
- 非根节点：ceil(m/2)-1<=x<=m-1

如果有子节点，子节点的个数：y=x+1

- 根结点个数：2<=y<=m
- 非根节点：ceil(m/2)<=y<=m
  - 若m=3，2<=y<=3因此三阶B树也常称之为(2,3)树或2-3树。
  - 若m=4，2<=y<=4因此三阶B树也常称之为(2,4)树或2-3-4树。
  - 若m=5，3<=y<=5因此三阶B树也常称之为(3,5)树。

#### 1.3 B树VS二叉搜索树

> 多代合并成为超级节点。
>
> n代合并，根节点最多有2^n个子节点，因此至少是2^n阶B树。

![image-20210324222341356](https://gitee.com/code1997/blog-image/raw/master/images/image-20210324222341356.png)

#### 1.4 B树操作

1）搜索

1. 先在节点内部从小到大开始搜索元素。
2. 如果命中，搜索结束。
3. 如果没有命中，再去对应的子节点中搜索元素，重复步骤1

2）添加

1. 新添加的元素必定是添加到叶子节点。
2. 如果某个节点的元素个数==B树的阶数，那么就会出现`上溢`。
   1. 假设上溢节点最中间的元素的位置为k
   2. 将k位置的元素向上与父节点合并。
   3. 将[0,k-1]和[k+1,m-1]位置的元素分裂成2个子节点。
   4. 2的操作可能会导致父节点上溢，那么就会继续重复1~3.极端情况是直到根节点。

图解：

![image-20210324224120073](https://gitee.com/code1997/blog-image/raw/master/images/image-20210324224120073.png)

上溢到跟根节点：使得B树的高度增加。

![image-20210324230938048](https://gitee.com/code1997/blog-image/raw/master/images/image-20210324230938048.png)

3）删除

- 如果删除的元素是叶子节点，直接删除即可。
- 如果删除的是非叶子节点。
  
  - 找到前驱或者后继，将删除节点覆盖掉，删除掉前驱或者后继
- 对于B树来说，非叶子节点的前驱或者后继元素，必定在叶子节点中，因此真正删除的元素都是发生在叶子节点中！！！因此也出现了`下溢`的问题，即元素的个数少于B树的节点的最低限制。
  - 下溢节点的元素数量必然等于ceil(m/2)-2。
  
  - 如果下溢节点邻近的兄弟节点，有至少ceil(m/2)个元素，可以向其借一个。
    - 将父节点的元素b插入到下溢节点的0的位置(最小)。
    
    - 将兄弟元素最大的元素a放到父节点b位置，
    
    - 这个操作其实就是旋转的操作。
    
      ![image-20210325203505369](https://gitee.com/code1997/blog-image/raw/master/images/image-20210325203505369.png)
    
  - 如果下溢节点邻近的兄弟节点，只有ceil(m/2)-1个元素，那么可以执行合并的操作。
  
    - 将父节点的元素b挪下来根左右节点进行合并。
  
    - 合并后的节点元素个数等于ceil(m/2)+ceil(m/2)-2，不超过m-1个。
    - 这个操作可能会导致父节点下溢，下溢的情况也可能会逐渐向上传播，极端情况下直到根节点。极端的情况下会导致B树的高度降低。

#### 1.5 4阶B树

1）性质：

- 根节点和非根节点的元素个数必定是1<=n<=3。
- 根节点和非根节点的字节点个数必定是2<=n<=4。

2）练习

- 添加：从1添加到22。
- 删除：从1删除到22。

### 2 红黑树

#### 2.1 红黑树的等价代换

红黑树和4阶B树具有等价性。

Black节点与他的Red子节点融合在一起，形成1个B树节点。

红黑树的black节点个数和4阶B树的节点总个数相等。

![image-20210325210416365](https://gitee.com/code1997/blog-image/raw/master/images/image-20210325210416365.png)

红黑树VS2-3-4树

![image-20210325210830434](https://gitee.com/code1997/blog-image/raw/master/images/image-20210325210830434.png)

思考：假设上图中的black节点是不存在的，那么整个B树就只存在一个节点。